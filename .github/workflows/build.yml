# This workflow builds the Flipper Application (FAP) against multiple
# firmware SDKs to ensure compatibility. It maintains a rolling "latest"
# release with the newest builds and changelog from conventional commits.

name: "FAP: Build and Release"

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    # Run once a day at 01:01 UTC to keep FAPs updated with SDK changes
    - cron: "1 1 * * *"
  workflow_dispatch:

# Ensures that only one workflow run for a given branch/ref is running at a time.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Official Dev
            fw-name: official-dev
            sdk-channel: dev
            sdk-hw-target: f7

          - name: Official Release
            fw-name: official-release
            sdk-channel: release
            sdk-hw-target: f7

          - name: Momentum Dev
            fw-name: momentum-dev
            sdk-index-url: https://up.momentum-fw.dev/firmware/directory.json
            sdk-channel: dev
            sdk-hw-target: f7

          - name: Momentum Release
            fw-name: momentum-release
            sdk-index-url: https://up.momentum-fw.dev/firmware/directory.json
            sdk-channel: release
            sdk-hw-target: f7

    name: "Build for ${{ matrix.name }}"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build FAP with ufbt
        uses: flipperdevices/flipperzero-ufbt-action@v0.1.3
        id: build-app
        with:
          sdk-channel: ${{ matrix.sdk-channel }}
          sdk-index-url: ${{ matrix.sdk-index-url }}
          sdk-hw-target: ${{ matrix.sdk-hw-target }}

      - name: Rename FAP files
        run: |
          mkdir -p dist
          for fap_path in ${{ steps.build-app.outputs.fap-artifacts }}; do
            if [[ "$fap_path" == *.fap ]]; then
              filename=$(basename "$fap_path")
              fap_name="${filename%.fap}"
              new_name="${fap_name}_${{ matrix.fw-name }}.fap"
              cp "$fap_path" "dist/$new_name"
              echo "Created: $new_name"
            fi
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.fw-name }}-build
          path: dist/

  release:
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release
        id: prepare
        run: |
          mkdir -p release
          find artifacts -name "*.fap" -exec cp {} release/ \;

          # Get version from application.fam
          VERSION=$(grep 'fap_version=' application.fam | sed 's/.*fap_version="\([^"]*\)".*/\1/' || echo "1.0")
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Generate changelog from conventional commits (last 20 commits)
          {
            echo "# Guess The Number v${VERSION}"
            echo ""
            echo "**Latest build from \`main\` branch**"
            echo ""
            echo "- **Updated:** $(date -u +'%Y-%m-%d %H:%M UTC')"
            echo "- **Trigger:** ${{ github.event_name }}"
            echo "- **Commit:** [\`$(git rev-parse --short HEAD)\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})"
            echo ""
            
            # Generate changelog from conventional commits
            echo "## Recent Changes"
            echo ""
            
            git log --oneline -20 --pretty=format:"- %s" | while read line; do
              # Format conventional commits nicely
              echo "$line" | sed \
                -e 's/^- feat/- âœ¨ **feat**/g' \
                -e 's/^- fix/- ðŸ› **fix**/g' \
                -e 's/^- docs/- ðŸ“š **docs**/g' \
                -e 's/^- style/- ðŸ’„ **style**/g' \
                -e 's/^- refactor/- â™»ï¸ **refactor**/g' \
                -e 's/^- perf/- âš¡ **perf**/g' \
                -e 's/^- test/- ðŸ§ª **test**/g' \
                -e 's/^- build/- ðŸ“¦ **build**/g' \
                -e 's/^- ci/- ðŸ‘· **ci**/g' \
                -e 's/^- chore/- ðŸ”§ **chore**/g'
            done
            
            echo ""
            echo ""
            echo "## Downloads"
            echo ""
            echo "| Firmware | Channel | File |"
            echo "|----------|---------|------|"
            echo "| Official | Dev | \`guess_the_number_official-dev.fap\` |"
            echo "| Official | Release | \`guess_the_number_official-release.fap\` |"
            echo "| Momentum | Dev | \`guess_the_number_momentum-dev.fap\` |"
            echo "| Momentum | Release | \`guess_the_number_momentum-release.fap\` |"
            echo ""
            echo "---"
            echo ""
            echo "ðŸ“¦ Download the \`.fap\` file matching your firmware and copy it to \`apps/Games/\` on your Flipper Zero."
          } > release_notes.md

          cat release_notes.md

      - name: Delete existing latest release
        run: |
          gh release delete latest --yes || true
          git push origin :refs/tags/latest || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "v${{ steps.prepare.outputs.version }} - Latest Build"
          body_path: release_notes.md
          prerelease: false
          files: release/*.fap
          make_latest: true
